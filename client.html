<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>User interface</title>
   <style>
       * { margin: 0; padding: 0; box-sizing: border-box; }
       body {
           font-family: Arial, sans-serif;
           background: linear-gradient(to right, #ffee00, #002fff);
           min-height: 100vh;
           color: #000000;
           padding: 8px;
       }
       .container { max-width: 100%; margin: 0 auto; }
       .viewer-header {
           text-align: center;
           margin-bottom: 20px;
       }
       h1 {
           color: #000000;
           margin-bottom: 8px;
           font-size: 18px;
           font-weight: bold;
           line-height: 1.2;
       }
       h2 {
           color: #000000;
           margin-bottom: 10px;
           font-size: 16px;
           border-bottom: 2px solid #000000;
           padding-bottom: 5px;
       }
       h3 {
           color: #000000;
           margin-bottom: 8px;
           font-size: 16px;
           font-weight: bold;
       }
       h4 {
           color: #000000;
           margin-bottom: 8px;
           font-size: 14px;
           font-weight: bold;
       }
       .live-indicator {
           font-weight: bold;
           color: #00aa00;
           margin-bottom: 6px;
           font-size: 12px;
       }
       .live-indicator.disconnected { color: #aa0000; }
       .live-indicator.no-game { color: #161616ca; }
       .connection-status {
           font-size: 11px;
           color: #000000;
       }
       .card {
           background: #ffffff;
           border: 1px solid #000000;
           padding: 12px;
           margin-bottom: 12px;
       }
       .score-display {
           display: grid;
           grid-template-columns: 1fr;
           gap: 12px;
           align-items: center;
           margin: 12px 0;
           padding: 12px;
           border: 1px solid #000000;
           background: #f5f5f5;
       }
       .team-score { text-align: center; padding: 8px; }
       .team-label {
           font-size: 14px;
           font-weight: bold;
           color: #000000;
           margin-bottom: 6px;
       }
       .score {
           font-size: 40px;
           font-weight: bold;
           color: #000000;
           line-height: 1;
       }
       .period-info {
           text-align: center;
           padding: 6px 12px;
           background: #000000;
           color: white;
           font-weight: bold;
           font-size: 12px;
       }
       .set-info {
           margin-top: 20px;
           text-align: center;
       }
       .set-info h3 {
           font-size: 24px;
           font-weight: bold;
           color: #000000;
           margin-bottom: 10px;
       }
       .sets-won {
           font-size: 20px;
           font-weight: bold;
           color: #000000;
       }
       .player-stats-container {
           margin-top: 15px;
           overflow-x: auto;
           -webkit-overflow-scrolling: touch;
           scrollbar-width: thin;
       }
       .player-stats-container::-webkit-scrollbar {
           height: 8px;
       }
       .player-stats-container::-webkit-scrollbar-track {
           background: #f1f1f1;
       }
       .player-stats-container::-webkit-scrollbar-thumb {
           background: #888;
           border-radius: 4px;
       }
       .previous-sets-container {
           margin-top: 30px;
           padding-top: 20px;
           border-top: 2px solid #000000;
       }
       .previous-sets-container h3 {
           font-size: 18px;
           font-weight: bold;
           color: #000000;
           margin-bottom: 15px;
           text-align: center;
       }
       .previous-set-section {
           margin-bottom: 25px;
       }
       .previous-set-section h4 {
           font-size: 16px;
           font-weight: bold;
           color: #000000;
           margin-bottom: 10px;
           text-align: center;
       }
       .player-stats-table {
           width: 100%;
           border-collapse: collapse;
           margin-top: 8px;
           background: #ffffff;
           border: 1px solid #000000;
           font-size: 11px;
           table-layout: auto;
       }
       .player-stats-table thead {
           background: #000000;
           color: white;
       }
       .player-stats-table th {
           padding: 6px 4px;
           text-align: center;
           font-weight: bold;
           font-size: 11px;
           border: 1px solid #ffffff;
           white-space: nowrap;
       }
       .player-stats-table th:first-child {
           text-align: left;
           min-width: 80px;
       }
       .player-stats-table td {
           padding: 6px 4px;
           border: 1px solid #000000;
           font-size: 11px;
       }
       .player-name {
           font-weight: bold;
           color: #000000;
           text-align: left;
           min-width: 80px;
       }
       .player-stat-value {
           text-align: center;
           font-weight: bold;
           color: #000000;
           font-size: 11px;
           min-width: 45px;
       }
       .waiting-message { text-align: center; }
       .hidden { display: none !important; }
       
   </style>
   
   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
       import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
       import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

       // Firebase configuration - same as admin (iacs project)
       const firebaseConfig = {
           apiKey: "AIzaSyBpkEnq2Kjotqm9Ukk2Cklj6ACZjWq1dEY",
           authDomain: "iacs-95ea7.firebaseapp.com",
           databaseURL: "https://iacs-95ea7-default-rtdb.asia-southeast1.firebasedatabase.app",
           projectId: "iacs-95ea7",
           storageBucket: "iacs-95ea7.firebasestorage.app",
           messagingSenderId: "413625128566",
           appId: "1:413625128566:web:b7499fd9a6e58d42203157",
           measurementId: "G-2ZKQ8M550N"
       };

       // Initialize Firebase
       const app = initializeApp(firebaseConfig);
       const analytics = getAnalytics(app);
       console.log('Firebase initialized for viewer');


       const realtimeDB = getDatabase(app);
       const realtimeGameRef = ref(realtimeDB, 'currentGame');


       let gameState = null;


       function updateLiveIndicator(status) {
           const indicator = document.getElementById('live-indicator');
           if (status === 'connected') {
               indicator.textContent = '● LIVE game';
               indicator.className = 'live-indicator';
           } else if (status === 'disconnected') {
               indicator.textContent = '● DISCONNECTED from database at the moment';
               indicator.className = 'live-indicator disconnected';
           } else if (status === 'no-game') {
               indicator.textContent = '● WAITING FOR THE Admin to start the game';
               indicator.className = 'live-indicator no-game';
           }
       }


       function updateDisplay() {
           const gamePanel = document.getElementById('game-panel');
           const waitingPanel = document.getElementById('waiting-panel');


           if (!gameState || !gameState.isActive) {
               gamePanel.classList.add('hidden');
               waitingPanel.classList.remove('hidden');
               updateLiveIndicator('no-game');
               return;
           }


           waitingPanel.classList.add('hidden');
           gamePanel.classList.remove('hidden');
           updateLiveIndicator('connected');


           // Update team names
           document.getElementById('display-team1').textContent = gameState.teams.team1.id || 'Team 1';
           document.getElementById('display-team2').textContent = gameState.teams.team2.id || 'Team 2';


           // Update scores
           document.getElementById('score1').textContent = gameState.teams.team1.score || 0;
           document.getElementById('score2').textContent = gameState.teams.team2.score || 0;


           // Update set info
           const setsWon1 = gameState.teams.team1.setsWon || 0;
           const setsWon2 = gameState.teams.team2.setsWon || 0;
           document.getElementById('period-display').textContent = `Set ${gameState.setNumber || 1}`;
           document.getElementById('sets-won').textContent = `${setsWon1} - ${setsWon2}`;


           // Update player statistics
           updatePlayerStats();
           
           // Update previous sets statistics
           updatePreviousSetsStats();
       }


       function updatePlayerStats() {
           const statsContainer = document.getElementById('player-stats-display');
           if (!statsContainer) return;


           const team1Label = gameState.teams.team1.id || 'Team 1';
           const team2Label = gameState.teams.team2.id || 'Team 2';


           let statsHtml = '';
           
           // Check if there are any player statistics to display
           const hasTeam1Players = gameState.players && gameState.players.team1 && Object.keys(gameState.players.team1).length > 0;
           const hasTeam2Players = gameState.players && gameState.players.team2 && Object.keys(gameState.players.team2).length > 0;
           
           if (hasTeam1Players || hasTeam2Players) {
               // Add "Current Set" heading
               statsHtml += '<div class="previous-set-section">';
               statsHtml += '<h4>Current Set</h4>';
           }


           // Team 1 players
           if (hasTeam1Players) {
               statsHtml += '<h3>' + team1Label + ' Player Statistics</h3>';
               statsHtml += '<table class="player-stats-table">';
               statsHtml += '<thead><tr><th>Player/Number</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
               statsHtml += '<tbody>';
              
               Object.keys(gameState.players.team1).forEach(function(playerName) {
                   const player = gameState.players.team1[playerName];
                   statsHtml += '<tr>';
                   statsHtml += '<td class="player-name">' + playerName + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                   statsHtml += '</tr>';
               });
              
               statsHtml += '</tbody></table>';
           }


           // Team 2 players
           if (hasTeam2Players) {
               statsHtml += '<h3>' + team2Label + ' Player Statistics</h3>';
               statsHtml += '<table class="player-stats-table">';
               statsHtml += '<thead><tr><th>Player/Number</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
               statsHtml += '<tbody>';
              
               Object.keys(gameState.players.team2).forEach(function(playerName) {
                   const player = gameState.players.team2[playerName];
                   statsHtml += '<tr>';
                   statsHtml += '<td class="player-name">' + playerName + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                   statsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                   statsHtml += '</tr>';
               });
              
               statsHtml += '</tbody></table>';
           }
           
           // Close the current set section if we opened it
           if (hasTeam1Players || hasTeam2Players) {
               statsHtml += '</div>';
           }


           if (statsHtml === '') {
               statsHtml = '<p>No player statistics available yet.</p>';
           }


           statsContainer.innerHTML = statsHtml;
       }


       function updatePreviousSetsStats() {
           const previousSetsContainer = document.getElementById('previous-sets-display');
           if (!previousSetsContainer) return;


           // Check if there are previous sets
           if (!gameState.setHistory || gameState.setHistory.length === 0) {
               previousSetsContainer.innerHTML = '';
               previousSetsContainer.classList.add('hidden');
               return;
           }


           previousSetsContainer.classList.remove('hidden');
           const team1Label = gameState.teams.team1.id || 'Team 1';
           const team2Label = gameState.teams.team2.id || 'Team 2';


           let previousSetsHtml = '';


           // Loop through each previous set
           gameState.setHistory.forEach(function(setData) {
               previousSetsHtml += '<div class="previous-set-section">';
               previousSetsHtml += '<h4>Set ' + setData.setNumber + ' - Final Score: ' + setData.team1Score + ' - ' + setData.team2Score + '</h4>';
               
               // Team 1 players from this set
               if (setData.team1Players && Object.keys(setData.team1Players).length > 0) {
                   previousSetsHtml += '<h4>' + team1Label + ' Player Statistics</h4>';
                   previousSetsHtml += '<table class="player-stats-table">';
                   previousSetsHtml += '<thead><tr><th>Player/Number</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
                   previousSetsHtml += '<tbody>';
                  
                   Object.keys(setData.team1Players).forEach(function(playerName) {
                       const player = setData.team1Players[playerName];
                       previousSetsHtml += '<tr>';
                       previousSetsHtml += '<td class="player-name">' + playerName + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                       previousSetsHtml += '</tr>';
                   });
                  
                   previousSetsHtml += '</tbody></table>';
               }
               
               // Team 2 players from this set
               if (setData.team2Players && Object.keys(setData.team2Players).length > 0) {
                   previousSetsHtml += '<h4>' + team2Label + ' Player Statistics</h4>';
                   previousSetsHtml += '<table class="player-stats-table">';
                   previousSetsHtml += '<thead><tr><th>Player/Number</th><th>Serves</th><th>Aces</th><th>Blocks</th><th>Spikes</th><th>Points</th></tr></thead>';
                   previousSetsHtml += '<tbody>';
                  
                   Object.keys(setData.team2Players).forEach(function(playerName) {
                       const player = setData.team2Players[playerName];
                       previousSetsHtml += '<tr>';
                       previousSetsHtml += '<td class="player-name">' + playerName + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.serves || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.aces || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.blocks || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.spikes || 0) + '</td>';
                       previousSetsHtml += '<td class="player-stat-value">' + (player.points || 0) + '</td>';
                       previousSetsHtml += '</tr>';
                   });
                  
                   previousSetsHtml += '</tbody></table>';
               }
               
               previousSetsHtml += '</div>';
           });


           previousSetsContainer.innerHTML = previousSetsHtml;
       }


       function subscribeToGame() {
           console.log('Connecting to Firebase Realtime Database...');


           // Monitor connection status
           const connectedRef = ref(realtimeDB, '.info/connected');
           onValue(connectedRef, (snapshot) => {
               if (snapshot.val() === true) {
                   console.log('✓ Connected to Firebase');
                   document.getElementById('connection-status').textContent = 'Connected to server';
               } else {
                   console.log('✗ Disconnected from Firebase');
                   document.getElementById('connection-status').textContent = 'Disconnected - reconnecting...';
                   updateLiveIndicator('disconnected');
               }
           });


           // Listen for game updates
           onValue(realtimeGameRef, (snapshot) => {
               console.log('Received game update');


               if (!snapshot.exists()) {
                   console.log('No game data found');
                   gameState = null;
                   updateDisplay();
                   return;
               }


               gameState = snapshot.val();
               console.log('Game state updated:', gameState);
               updateDisplay();
           }, (error) => {
               console.error('Error connecting to database:', error);
               updateLiveIndicator('disconnected');
           });
       }


       // message hha nga
       document.addEventListener('DOMContentLoaded', function() {
           console.log('Viewer page loaded');
           subscribeToGame();
       });
   </script>
</head>
<body>
   <div class="container">
       <div class="viewer-header">
           <div id="live-indicator" class="live-indicator no-game">CONNECTING...SOON</div>
           <h1>Volleyball tournament live game stats</h1>
           <div id="connection-status" class="connection-status">Connecting to server... please wait</div>
       </div>

       <div id="waiting-panel" class="card">
           <div class="waiting-message">
               <h2>Waiting for Game</h2>
               <p>The game will start shortly...</p>
               <p>The score will appear here automatically when a match starts.</p>
           </div>
       </div>


       <!-- Game panel - shown when game is active -->
       <div id="game-panel" class="hidden">
           <div class="card">
               <div class="score-display">
                   <div class="team-score">
                       <div class="team-label" id="display-team1">Team 1</div>
                       <div class="score" id="score1">0</div>
                   </div>
                   <div class="period-info">
                       <div id="period-display">Set 1</div>
                   </div>
                   <div class="team-score">
                       <div class="team-label" id="display-team2">Team 2</div>
                       <div class="score" id="score2">0</div>
                   </div>
               </div>


               <div class="set-info">
                   <h3>The web is down for technical issues, This is Student individual project, school holds no responsibility. sorry</h3>
                   <div class="sets-won" id="sets-won">0 - 0</div>
               </div>
           </div>


           <div class="card">
               <h2>Player Statistics</h2>
               <div class="player-stats-container" id="player-stats-display">
                   <p>No player statistics available yet.</p>
               </div>
               <div class="previous-sets-container hidden" id="previous-sets-display">
                   <h3>Previous Sets Statistics</h3>
               </div>
           </div>
       </div>
   </div>
</body>
</html>



